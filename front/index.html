<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bug Farm</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .bug-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; display: grid; grid-template-columns: 250px 1fr auto; gap: 20px; align-items: center; }
        .bar-container { background: #eee; height: 20px; border-radius: 10px; overflow: hidden; position: relative; }
        .bar { height: 100%; transition: width 0.3s; }
        .health-bar { background: #28a745; }
        .energy-bar { background: #007bff; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 12px; line-height: 20px; color: #000; font-weight: bold; }
        table { border-collapse: collapse; table-layout: fixed; }
        td { width: 20px; height: 20px; border: 1px solid #eee; text-align: center; font-size: 10px; padding: 0; overflow: hidden; }
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-add { background: #28a745; color: white; font-size: 16px; }
        .btn-log { background: #17a2b8; color: white; }
        .btn-del { background: #dc3545; color: white; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; max-height: 80%; overflow-y: auto; border-radius: 8px; }
        #logContent { background: #1e1e1e; color: #00ff00; padding: 15px; font-family: monospace; white-space: pre-wrap; }
        #experienceContent { background: #fff3cd; color: #856404; padding: 15px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #ffeeba; font-style: italic; }
        
        .form-container { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #ddd; }
        .form-group { margin-bottom: 10px; }
        input, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div id="authHeader" style="background: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;">
        <div id="userBlock">
            <button onclick="document.getElementById('loginModal').style.display='block'">Login</button>
            <button onclick="document.getElementById('registerModal').style.display='block'">Sign Up</button>
        </div>
    </div>

    <div class="header">
        <h1>Bug Farm</h1>
        <button class="btn-add" id="addBugBtn">+ Add Bug</button>
    </div>

    <!-- Auth Modals -->
    <div id="loginModal" class="modal">
        <div class="modal-content" style="width: 300px;">
            <h3>Login</h3>
            <input type="text" id="loginUser" placeholder="Username" style="margin-bottom: 10px;">
            <input type="password" id="loginPass" placeholder="Password" style="margin-bottom: 10px;">
            <button class="btn-add" id="doLogin">Login</button>
            <button onclick="document.getElementById('loginModal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content" style="width: 300px;">
            <h3>Sign Up</h3>
            <input type="text" id="regUser" placeholder="Username" style="margin-bottom: 10px;">
            <input type="password" id="regPass" placeholder="Password" style="margin-bottom: 10px;">
            <button class="btn-add" id="doRegister">Create Account</button>
            <button onclick="document.getElementById('registerModal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div id="addForm" class="form-container">
        <h3>New Subject</h3>
        <div class="form-group"><input type="password" id="apiKey" placeholder="OpenRouter API Key" value="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"></div>
        <div class="form-group"><input type="text" id="model" value="arcee-ai/trinity-large-preview:free"></div>
        <div class="form-group"><textarea id="systemPrompt" rows="3">
You are a bug's brain in a simulation. Your goal is to explore the world, form experience, and survive.
You must analyze data about the world, your memory (past events), your state, your experience, draw conclusions, and create a plan for further actions.
Experience: everything you know about this world and its rules, improve it and expand it.
Memory data comes as an array with the following structure:
1) turnN - turn number
1) viewMap what you saw this turn - an array of objects in your field of view {x, y, type}. type 1 - food, type 2 - another bug. Your coordinates are always 0,0. What is in front of you and can be bitten has coordinates 0,1. 45 degrees left is -1,1, 45 degrees right is 1,1. Visibility is limited to 5 cells forward.
2) feeling: state object with the following structure
 - energy your energy in percent, food restores energy
 - health - your health in percent. If 0, you are dead.
 - pain - pain if someone bites you, the angle from your direction of view where the bite came from will be indicated.
 - currentPlan - current plan being executed, if not empty it's better to wait for completion. Respond with actionId=0 while currentPlan is not empty, otherwise you'll get stuck. Only in extreme cases when you want to change action can you send another.
 3) lastAction - last executed action
The last entry is always the last turn that just happened.

Available actions:
0 (IDLE) - stay in place
1 (MOVE) - forward
2 (ROTATE) with payload {"angle": 90} or {"angle": -90}
3 (BITE) - bite in front of you.

Your response consists of:
- plan - action plan for a certain number of turns, decide for yourself how deep you plan
- experience accumulated experience - analyze and explore the world and game rules, draw conclusions. When you want to update experience, send it as text, keep past experience and add new to it. Change past experience if necessary. If there is no new experience, send null.
- reason A brief description of your thoughts and motives in one sentence.
- mood - utf-8 icon with your mood

Respond ONLY with a JSON object:
{
    "plan": [{"actionId": number, "payload": {}}, {...}],
    "reason": "...",
    "experience": "...",
    "mood": "..."
}
        </textarea></div>
        <div style="display: flex; gap: 10px;" class="form-group">
            <input type="text" id="name" value="Farm_Bug">
            <input type="number" id="x" value="5">
            <input type="number" id="y" value="5">
        </div>
        <button class="btn-add" id="confirmAdd">Create and Start AI</button>
        <button onclick="document.getElementById('addForm').style.display='none'">Cancel</button>
    </div>

    <div id="bugList"></div>

    <hr>
    <div id="worldStats" style="background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; gap: 20px; font-weight: bold;">
        <span>Turn: <span id="statTurnN">-</span></span>
        <span>Decision Time: <span id="statDecisionTime">-</span>s</span>
        <span>Activity: <span id="statActivity">-</span>%</span>
    </div>
    <h3>World Map</h3>
    <div id="worldMapContainer" style="overflow: auto; max-height: 600px; border: 1px dashed #ccc; width: 100%; background: white;"></div>

    <div id="logModal" class="modal">
        <div class="modal-content">
            <span style="float:right; cursor:pointer; font-size:24px;" onclick="document.getElementById('logModal').style.display='none'">&times;</span>
            <h3>Experience and Knowledge</h3>
            <div id="experienceContent">No experience accumulated yet...</div>
            <h3>Vision</h3>
            <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
                <div style="font-size: 40px;">üëÅÔ∏è</div>
                <div id="bugViewGrid" style="background: #fff; border: 1px solid #ccc;"></div>
            </div>
            <h3>Action Log</h3>
            <div id="logContent"></div>
        </div>
    </div>

    <script type="module" src="js/FarmController.js"></script>
</body>
</html>
