# AiBugs API Documentation

Базовый URL: `/api`

## Эндпоинты

### 1. Добавление юнита (Жука)
`POST /addUnit`

Добавляет нового жука на карту в заданных координатах.

**Запрос:**
```json
{
  "name": "BugName",
  "x": 10,
  "y": 10,
  "angle": 0
}
```
* `angle`: 0 (вправо), 90 (вниз), 180 (влево), 270 (вверх).

**Ответ:**
```json
{
  "uid": "uuid-строка-юнита"
}
```

---

### 2. Зрение жука
`GET /watch/:unitUid`

Получает матрицу того, что видит жук в данный момент (треугольная область перед ним).

**Ответ:**
```json
{
  "turnN": 42,
  "viewMap": [
    {"x": 11, "y": 10, "type": 1},
    {"x": 12, "y": 9, "type": 0}
  ]
}
```
* `type`: 0 — пусто, 1 — еда, 2 — другой жук.

---

### 3. Планирование действий
`POST /action/:unitUid`

Устанавливает план действий на будущие ходы. При получении нового списка старый план полностью перезаписывается. Максимальное количество действий в списке ограничено `memory_limit` (по умолчанию 10).

**Запрос:**
```json
{
  "initTourN": 42,
  "actions": [
    { "actionId": 1, "payload": {} },
    { "actionId": 2, "payload": { "angle": 90 } },
    { "actionId": 3, "payload": {} }
  ]
}
```

**Константы `actionId`:**
* `0` (IDLE): Бездействие.
* `1` (MOVE): Движение вперед на 1 клетку.
* `2` (ROTATE): Поворот. В `payload` нужно передать `{"angle": 90}` или `{"angle": -90}`.
* `3` (BITE): Укусить объект перед собой (еду или другого жука).

**Ответ:**
```json
{
  "status": "queued"
}
```
*В случае повторного действия в тот же ход вернет ошибку 400.*

---

### 4. Ощущения жука
`GET /feel/:unitUid`

Получает текущие физические ощущения жука.

**Ответ:**
```json
{
  "turnN": 42,
  "feeling": [
    {"energy": 100},
    {"health": 100},
    {"pain": 90},
    {"currentPlan": [
      { "actionId": 1, "payload": {} },
      { "actionId": 2, "payload": { "angle": 90 } }
    ]}
  ]
}
```
* `pain`: угол (относительно направления жука), с которого пришла боль.
* `energy`/`health`: числовые значения текущих показателей.

---

### 5. Память жука
`GET /memory/:unitUid`

Возвращает историю последних ходов (лимит — 10 записей).

**Ответ:**
```json
{
  "memory": [
    {
      "turnN": 41,
      "viewMap": [...],
      "feeling": [...],
      "lastAction": { "actionId": 1, "status": "OK" },
      "brainSleeping": true
    }
  ]
}
```
* `lastAction`: результат выполнения действия в этом ходу. `status` может быть `OK` или `Fail`.
* `brainSleeping`: `true`, если жук выполняет план и в очереди осталось более одного действия. Становится `false`, когда остается последнее действие, план пуст, прерван ошибкой или жука укусили.

---

### 6. WebSocket обновления
`WS /?uid=:unitUid`

Подключение к WebSocket позволяет получать обновления состояния жука в реальном времени после каждого хода.

**Событие (приходит каждый ход):**
Отправляется массив объектов, представляющий всю текущую память жука.

**Формат сообщения:**
```json
[
  {
    "turnN": 42,
    "viewMap": [...],
    "feeling": [...],
    "lastAction": { "actionId": 1, "status": "OK" },
    "brainSleeping": true
  },
  ...
]
```

---

### 7. Удаление юнита
`DELETE /unit/:unitUid`

Удаляет жука из мира.

**Ответ:**
```json
{
  "status": "deleted",
  "uid": "uuid"
}
```

---

### 8. Список всех юнитов и еды
`GET /units`

Возвращает краткую информацию о всех существующих жуках и объектах еды в мире.

**Ответ:**
```json
{
  "units": [
    {
      "uid": "uuid",
      "name": "BugName",
      "x": 10,
      "y": 10,
      "angle": 0,
      "is_live": true,
      "current_health": 100,
      "current_energy": 10000
    }
  ],
  "food": [
    {
      "x": 15,
      "y": 20,
      "amount": 500,
      "type": 1
    }
  ]
}
```

## Механика времени
* Начальное время хода: 10 секунд.
* Динамически меняется от 1 до 30 секунд в зависимости от того, все ли жуки успели прислать действия.
